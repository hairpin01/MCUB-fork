<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MCUB ‚Äì Setup</title>
<!-- QR Code library-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Hubballi&family=JetBrains+Mono:wght@300;400;600&display=swap">
<style>
:root {
  --accent:      #7c3aed;
  --accent-glow: #5b21b6;
  --accent-soft: rgba(124,58,237,.18);

  --bg:       #0d0d12;
  --bg2:      #13131a;
  --card:     rgba(20,18,30,.72);
  --border:   rgba(124,58,237,.22);
  --text:     #e8e6f0;
  --text-dim: #6b6880;
  --input-bg: rgba(10,8,18,.7);
  --glow-col: #4c1d95;
  --err-bg:   rgba(127,29,29,.35);
  --err-border:rgba(239,68,68,.4);
  --err-text: #fca5a5;
}
[data-theme="light"] {
  --bg:       #f0eefa;
  --bg2:      #e8e2f7;
  --card:     rgba(255,255,255,.85);
  --border:   rgba(124,58,237,.3);
  --text:     #1e1a2e;
  --text-dim: #8b80a8;
  --input-bg: rgba(255,255,255,.9);
  --glow-col: #c4b5fd;
  --err-bg:   rgba(254,226,226,.8);
  --err-border:rgba(239,68,68,.5);
  --err-text: #b91c1c;
}

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}

html,body{
  width:100%;height:100%;
  background:var(--bg);
  color:var(--text);
  font-family:Hubballi,sans-serif;
  transition:background .4s,color .4s;
}

.blob{
  position:fixed;inset:0;z-index:0;pointer-events:none;
  background:radial-gradient(ellipse 60% 50% at 50% 60%, var(--glow-col) 0%, transparent 70%);
  opacity:.55;
  transition:background .5s;
}

.lights{
  position:fixed;inset:0;z-index:1;pointer-events:none;overflow:hidden;
  animation:fi .8s ease forwards .5s;opacity:0;
}
.light{
  position:absolute;width:3px;background:#fff;
  top:100vh;left:0;right:0;bottom:0;margin:auto;
  filter:blur(4px);
}
.x1{filter:blur(3px);animation:floatUp 4s infinite linear;}
.x2{filter:blur(3px);animation:floatUp 7s infinite linear;transform:scale(1.6);left:15%;}
.x3{filter:blur(3px);animation:floatUp 2.5s infinite linear;transform:scale(.5);left:-15%;}
.x4{filter:blur(5px);animation:floatUp 4.5s infinite linear;transform:scale(1.2);left:-34%;}
.x5{filter:blur(6px);animation:floatUp 8s infinite linear;transform:scale(2.2);left:-57%;}
.x6{filter:blur(4px);animation:floatUp 3s infinite linear;transform:scale(.8);left:-81%;}
.x7{filter:blur(3px);animation:floatUp 5.3s infinite linear;transform:scale(3.2);left:37%;}
.x8{filter:blur(6px);animation:floatUp 4.7s infinite linear;transform:scale(1.7);left:62%;}
.x9{filter:blur(3px);animation:floatUp 4.1s infinite linear;transform:scale(.9);left:85%;}

@keyframes floatUp{
  0%{top:100vh;opacity:0;}25%{opacity:1;}50%{top:0;opacity:.8;}75%{opacity:1;}100%{top:-100vh;opacity:0;}
}
@keyframes fi{to{opacity:1;}}

@keyframes slideOut {
  to {
    opacity: 0;
    transform: translateX(-18px);
  }
}
#sky{position:fixed;inset:0;overflow:hidden;z-index:1;pointer-events:none;}
#shootingstars{
  position:fixed;overflow:hidden;
  width:150vh;height:100vw;
  transform:translateX(calc(50vw - 50%)) translateY(calc(50vh - 50%)) rotate(120deg);
}
.wish{
  height:2px;width:100px;top:300px;
  position:absolute;opacity:0;
  background:linear-gradient(-45deg,#fff,rgba(0,0,255,0));
  filter:drop-shadow(0 0 6px #fff);
}
.theme-toggle{
  position:fixed;top:18px;right:18px;z-index:999;
  width:38px;height:38px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:50%;
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:1.1rem;
  backdrop-filter:blur(8px);
  transition:border-color .2s,box-shadow .2s,background .3s;
  user-select:none;
}
.theme-toggle:hover{
  border-color:var(--accent);
  box-shadow:0 0 14px -4px var(--accent);
}

#toasts{
  position:fixed;top:18px;left:18px;z-index:9999;
  display:flex;flex-direction:column;gap:8px;
  max-width:340px;
}
.toast{
  display:flex;align-items:flex-start;gap:10px;
  padding:11px 14px;
  background:var(--err-bg);
  border:1px solid var(--err-border);
  border-radius:7px;
  backdrop-filter:blur(10px);
  font-family:'JetBrains Mono',monospace;
  font-size:.76rem;
  color:var(--err-text);
  line-height:1.45;
  animation:slideIn .25s ease;
  cursor:pointer;
}
.toast.ok{
  background:rgba(5,46,22,.4);
  border-color:rgba(34,197,94,.4);
  color:#86efac;
}
.toast-icon{flex-shrink:0;margin-top:1px;}
.toast-close{margin-left:auto;flex-shrink:0;opacity:.5;padding-left:6px;}
@keyframes slideIn{from{opacity:0;transform:translateX(-18px);}to{opacity:1;transform:none;}}
@keyframes slideOut{to{opacity:0;transform:translateX(-18px);}}

.page{
  min-height:100vh;
  display:flex;flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:30px 16px 40px;
  position:relative;z-index:2;
}

.logo-row{
  display:flex;align-items:center;gap:14px;
  margin-bottom:6px;
}
.logo-img{
    height:2rem;
    width:auto;
    object-fit:contain;
}
.logo-text{
  font-family:'JetBrains Mono',monospace;
  font-size:2rem;font-weight:600;
  letter-spacing:.18em;
  color:var(--accent);
  text-shadow:0 0 24px var(--accent);
}
.subtitle{
  font-size:.88rem;color:var(--text-dim);
  text-align:center;margin-bottom:18px;
}

.steps-bar{
  display:flex;align-items:center;
  justify-content:center;
  margin-bottom:18px;
}
.step{display:flex;flex-direction:column;align-items:center;gap:3px;opacity:.35;transition:opacity .25s;}
.step.active,.step.done{opacity:1;}
.snum{
  width:28px;height:28px;border-radius:50%;
  border:1px solid var(--text-dim);color:var(--text-dim);
  display:flex;align-items:center;justify-content:center;
  font-family:'JetBrains Mono',monospace;font-weight:600;font-size:.78em;
  transition:background .25s,border-color .25s,color .25s;
}
.step.active .snum{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 0 12px var(--accent);}
.step.done   .snum{background:#16a34a;border-color:#16a34a;color:#fff;}
.slabel{font-size:.65em;color:var(--text-dim);white-space:nowrap;}
.step.active .slabel,.step.done .slabel{color:var(--text);}
.sconn{flex:1;height:1px;background:var(--border);min-width:28px;margin-bottom:14px;}

.wizard-card{
  width:100%;max-width:460px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:10px;
  padding:28px 30px;
  backdrop-filter:blur(12px);
  box-shadow:0 8px 48px -12px rgba(124,58,237,.25);
  transition:background .3s,border-color .3s;
}
.wstep h2{font-size:1.25rem;color:var(--text);margin-bottom:5px;}
.hint{font-size:.83rem;color:var(--text-dim);line-height:1.55;margin-bottom:18px;}
.hint a{color:var(--accent);text-decoration:none;}
.hint.small{font-size:.76rem;}

label{
  display:flex;flex-direction:column;gap:5px;
  margin-bottom:13px;
  font-family:'JetBrains Mono',monospace;
  font-size:.75rem;color:var(--text-dim);letter-spacing:.04em;
}
input[type=text],input[type=tel],input[type=password]{
  width:100%;padding:9px 12px;
  background:var(--input-bg);
  border:1px solid var(--border);
  border-radius:5px;
  color:var(--text);
  font-family:'JetBrains Mono',monospace;font-size:.9rem;
  outline:none;
  transition:border-color .2s,box-shadow .2s,background .3s;
}
input:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px var(--accent-soft);
}
input::placeholder{color:var(--text-dim);opacity:.55;}

.btn-primary{
  width:100%;padding:10px 16px;
  background:transparent;
  color:var(--accent);
  border:1px solid var(--accent);
  border-radius:6px;
  font-family:'JetBrains Mono',monospace;font-size:.88rem;
  cursor:pointer;
  transition:background .2s,color .2s,box-shadow .2s,transform .1s;
  margin-top:0;
  white-space:nowrap;
}
.btn-primary:hover:not(:disabled){
  background:var(--accent);color:#fff;
  box-shadow:0 0 20px -6px var(--accent);
}
.btn-primary:active:not(:disabled){ transform:scale(.97); }
.btn-primary:disabled{opacity:.35;cursor:not-allowed;}

.btn-ghost{
  width:100%;padding:10px 16px;
  background:transparent;color:var(--text-dim);
  border:1px solid var(--border);border-radius:6px;
  font-family:'JetBrains Mono',monospace;font-size:.88rem;
  cursor:pointer;transition:border-color .2s,color .2s,transform .1s;
  white-space:nowrap;
}
.btn-ghost:hover{ border-color:var(--text-dim);color:var(--text); }
.btn-ghost:active{ transform:scale(.97); }

.btn-row{ display:flex; gap:8px; margin-top:8px; }
.btn-row > button { flex:1; margin:0; }

.wstep > .btn-primary,
.wstep > .btn-ghost { margin-bottom:8px; }

.done-icon{font-size:2.8rem;text-align:center;margin-bottom:6px;}
.spinner{
  width:30px;height:30px;
  border:2px solid var(--border);border-top-color:var(--accent);
  border-radius:50%;animation:spin .7s linear infinite;margin:14px auto;
}
@keyframes spin{to{transform:rotate(360deg);}}

.reset-bar{
  font-family:'JetBrains Mono',monospace;
  font-size:.68rem;color:var(--text-dim);
  text-align:center;margin-bottom:12px;
}
.reset-link{color:var(--text-dim);text-decoration:none;transition:color .2s;}
.reset-link:hover{color:var(--accent);}

.setup-footer{
  margin-top:18px;
  font-size:.72rem;color:var(--text-dim);
  font-family:Hubballi;
}

.hidden{display:none!important;}

.page { animation: pageFadeUp .55s cubic-bezier(.22,1,.36,1) both; }
@keyframes pageFadeUp {
  from { opacity:0; transform:translateY(22px); }
  to   { opacity:1; transform:none; }
}

.wizard-card { animation: cardPop .5s cubic-bezier(.22,1,.36,1) .1s both; }
@keyframes cardPop {
  from { opacity:0; transform:scale(.96) translateY(12px); }
  to   { opacity:1; transform:none; }
}

.wstep { animation: stepIn .32s cubic-bezier(.22,1,.36,1) both; }
@keyframes stepIn {
  from { opacity:0; transform:translateX(18px); }
  to   { opacity:1; transform:none; }
}
.wstep.slide-back { animation: stepInBack .32s cubic-bezier(.22,1,.36,1) both; }
@keyframes stepInBack {
  from { opacity:0; transform:translateX(-18px); }
  to   { opacity:1; transform:none; }
}

.logo-img {
  animation: logoPulse 3s ease-in-out infinite;
  filter: drop-shadow(0 0 0px var(--accent));
}
@keyframes logoPulse {
  0%,100% { filter: drop-shadow(0 0 4px var(--accent)) drop-shadow(0 0 0px var(--accent-glow)); }
  50%      { filter: drop-shadow(0 0 14px var(--accent)) drop-shadow(0 0 8px var(--accent-glow)); }
}

.step.active .snum { animation: dotBounce .35s cubic-bezier(.34,1.56,.64,1); }
@keyframes dotBounce {
  from { transform: scale(.6); }
  to   { transform: scale(1); }
}

.sconn { position:relative; overflow:hidden; }
.sconn::after {
  content:''; position:absolute; inset:0;
  background:var(--accent);
  transform:scaleX(0); transform-origin:left;
  transition:transform .4s ease;
}
.sconn.filled::after { transform:scaleX(1); }

.blob { animation: blobDrift 8s ease-in-out infinite alternate; }
@keyframes blobDrift {
  from { background-position: 40% 55%; transform: scale(1); }
  to   { background-position: 60% 65%; transform: scale(1.06); }
}

@keyframes inputShake {
  0%,100% { transform:none; }
  20%     { transform:translateX(-6px); }
  40%     { transform:translateX(6px); }
  60%     { transform:translateX(-4px); }
  80%     { transform:translateX(4px); }
}
input.shake { animation: inputShake .4s ease; border-color: rgba(239,68,68,.8) !important; }

.done-icon img { animation: successBounce .6s cubic-bezier(.34,1.56,.64,1) .1s both; }
@keyframes successBounce {
  from { transform:scale(0) rotate(-20deg); opacity:0; }
  to   { transform:scale(1) rotate(0); opacity:1; }
}

#resetModal { transition: opacity .2s; }
#resetModal > div { animation: modalPop .25s cubic-bezier(.22,1,.36,1); }
@keyframes modalPop {
  from { transform:scale(.92); opacity:0; }
  to   { transform:none; opacity:1; }
}

#qr-image { animation: qrFadeIn .4s ease .1s both; }
@keyframes qrFadeIn {
  from { opacity:0; transform:scale(.9); }
  to   { opacity:1; transform:none; }
}

#qr-image.refreshed { animation: qrFadeIn .3s ease both; }

.btn-primary, .btn-ghost {
  position: relative; overflow: hidden;
}
.ripple {
  position:absolute; border-radius:50%;
  background:rgba(255,255,255,.25);
  transform:scale(0);
  animation:rippleAnim .5s linear;
  pointer-events:none;
}
@keyframes rippleAnim {
  to { transform:scale(4); opacity:0; }
}


#reauthPage .wizard-card { animation: cardPop .5s cubic-bezier(.22,1,.36,1) .15s both; }

@media(max-width:520px){
  .wizard-card{padding:20px 16px;}
  .slabel{display:none;}
  .sconn{min-width:16px;}
}
</style>
</head>
<body>

<!-- bg -->
<div class="blob"></div>
<div class="lights">
  <div class="light x1"></div><div class="light x2"></div><div class="light x3"></div>
  <div class="light x4"></div><div class="light x5"></div><div class="light x6"></div>
  <div class="light x7"></div><div class="light x8"></div><div class="light x9"></div>
</div>
<div id="sky"><div id="shootingstars">
  <div class="wish"></div><div class="wish"></div><div class="wish"></div>
  <div class="wish"></div><div class="wish"></div><div class="wish"></div>
  <div class="wish"></div><div class="wish"></div><div class="wish"></div>
  <div class="wish"></div>
</div></div>

<button class="theme-toggle" id="themeToggle" title="Toggle theme">üåô</button>

<div id="toasts"></div>

<div class="page" id="setupPage">

  <div class="logo-row">
    <img src="/static/img/0.png" alt="MCUB" class="logo-img">
  </div>
  <p class="subtitle">First-time setup</p>

  <div class="steps-bar">
    <div class="step active" id="dot-1"><span class="snum">1</span><span class="slabel">Credentials</span></div>
    <div class="sconn"></div>
    <div class="step" id="dot-1qr"><span class="snum">QR</span><span class="slabel">Scan</span></div>
    <div class="sconn"></div>
    <div class="step" id="dot-2"><span class="snum">2</span><span class="slabel">Code</span></div>
    <div class="sconn"></div>
    <div class="step" id="dot-3"><span class="snum">3</span><span class="slabel">2FA</span></div>
    <div class="sconn"></div>
    <div class="step" id="dot-4"><span class="snum">4</span><span class="slabel">Bot</span></div>
    <div class="sconn"></div>
    <div class="step" id="dot-5"><span class="snum">5</span><span class="slabel">Done</span></div>
  </div>

  <div class="wizard-card">

    <!-- Step 1 -->
    <div class="wstep" id="s1">
      <h2>API Credentials</h2>
      <p class="hint">
        Open <a href="https://my.telegram.org" target="_blank">my.telegram.org</a>
        ‚Üí API development tools ‚Üí create app ‚Üí paste values below.
      </p>
      <label>API ID
        <input id="f_api_id" type="text" inputmode="numeric" placeholder="12345678" autocomplete="off">
      </label>
      <label>API Hash
        <input id="f_api_hash" type="text" placeholder="0123456789abcdef‚Ä¶" autocomplete="off">
      </label>
      <label>Phone number
        <input id="f_phone" type="tel" placeholder="+1234567890" autocomplete="tel">
      </label>
      <div class="btn-row">
        <button class="btn-primary" id="btn1" onclick="step1()">Send code</button>
        <button class="btn-ghost" id="btn1_qr" onclick="step1QR()">QR Code</button>
      </div>
    </div>

    <!-- Step 1.5: QR Code -->
    <div class="wstep hidden" id="s1qr">
      <h2>Scan QR Code</h2>
      <p class="hint">Scan this QR code with your Telegram app to log in.</p>
      <div id="qr-container" style="text-align:center;margin:20px 0;">
        <div id="qr-image" style="display:inline-block;padding:12px;background:#fff;border-radius:8px;"></div>
      </div>
      <p class="hint small" id="qr-status">Waiting for scan...</p>
      <div class="btn-row">
        <button class="btn-ghost" onclick="show(1)">Back</button>
        <button class="btn-primary" id="btn_qr_poll" onclick="pollQR()">Check Again</button>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="wstep hidden" id="s2">
      <h2>Telegram Code</h2>
      <p class="hint">A code was sent to your Telegram account. Enter it below.</p>
      <label>Code
        <input id="f_code" type="text" inputmode="numeric" placeholder="12345" autocomplete="one-time-code" maxlength="10">
      </label>
      <div class="btn-row">
        <button class="btn-ghost" onclick="show(1)">‚Üê Back</button>
        <button class="btn-primary" id="btn2" onclick="step2()">Verify ‚Üí</button>
      </div>
    </div>

    <!-- Step 3 -->
    <div class="wstep hidden" id="s3">
      <h2>Two-Factor Auth</h2>
      <p class="hint">Your account has 2FA enabled. Enter your cloud password.</p>
      <label>Cloud password
        <input id="f_pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password">
      </label>
      <div class="btn-row">
        <button class="btn-ghost" onclick="show(2)">‚Üê Back</button>
        <button class="btn-primary" id="btn3" onclick="step3()">Confirm ‚Üí</button>
      </div>
    </div>

    <!-- Step 4: Bot -->
    <div class="wstep hidden" id="s4">
      <h2>Inline Bot (Optional)</h2>
      <p class="hint">
        Create a bot via @BotFather for inline buttons support.<br>
        Or skip this step and create bot later in settings.
      </p>
      <label>Bot Token (leave empty to skip)
        <input id="f_bot_token" type="text" placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz">
      </label>
      <button class="btn-primary" id="btn4verify" onclick="verifyBotInSetup()">Verify Token</button>
      <button class="btn-ghost" id="btn4auto" onclick="autoCreateBot()">Auto Create Bot</button>
      <div class="btn-row">
        <button class="btn-ghost" onclick="skipBot()">Skip ‚Üí</button>
        <button class="btn-primary" id="btn4" onclick="finishWithBot()" disabled>Continue ‚Üí</button>
      </div>
    </div>

    <!-- Step 5 -->
    <div class="wstep hidden" id="s5">
      <div class="done-icon"><img src="/static/img/success.png" alt="Success" style="width:60px;height:60px;"></div>
      <h2>MCUB is installed!</h2>
      <p class="hint">Kernel is starting ‚Äî redirecting to dashboard‚Ä¶</p>
      <div class="spinner"></div>
      <p class="hint small" id="poll-status">Waiting for kernel‚Ä¶</p>
    </div>

  </div>

  <div class="reset-bar">
    Already configured? <a href="#" class="reset-link" onclick="showResetChoice();return false;">Reset & reconfigure</a>
  </div>
  <div class="reset-bar" style="margin-top:8px;">
    <a href="/bot" class="reset-link">Bot Settings</a>
  </div>

  <div id="resetModal" class="hidden" style="position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.7);">
    <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:24px;max-width:360px;width:90%;">
      <h3 style="margin-bottom:12px;">Choose Login Method</h3>
      <p class="hint" style="margin-bottom:18px;">How would you like to log in to your Telegram account?</p>
      <button class="btn-primary" onclick="resetAndChoose('qr')">Login via QR Code</button>
      <div class="btn-row" style="margin-top:8px;">
        <button class="btn-ghost" onclick="resetAndChoose('code')">Send Code</button>
        <button class="btn-ghost" onclick="document.getElementById('resetModal').classList.add('hidden')">Cancel</button>
      </div>
    </div>
  </div>

  <footer class="setup-footer">MCUB Kernel ‚Äì setup wizard</footer>
</div>

<div class="page hidden" id="reauthPage">
  <div class="logo-row">
    <img src="/static/img/0.png" alt="MCUB" class="logo-img">
  </div>
  <p class="subtitle">Session Expired</p>

  <div class="wizard-card">
    <h2>Re-authenticate</h2>
    <p class="hint">Your session has expired. Please log in again to continue.</p>
    <div class="btn-row" style="margin-top:20px;">
      <button class="btn-primary" onclick="showReauthQR()">QR Code</button>
      <button class="btn-ghost" onclick="showReauthCode()">Send Code</button>
    </div>
  </div>

  <div class="reset-bar">
    <a href="/setup/reset" class="reset-link">Reset & start fresh</a>
  </div>
  <footer class="setup-footer">MCUB Kernel ‚Äì setup wizard</footer>
</div>

<!-- Bot Settings Page -->
<div class="page hidden" id="botPage">

  <div class="logo-row">
    <img src="/static/img/0.png" alt="MCUB" class="logo-img">
  </div>
  <p class="subtitle">Inline Bot Settings</p>

  <div class="wizard-card">
    <div id="botStatus">
      <div class="spinner"></div>
      <p class="hint">Loading...</p>
    </div>

    <div id="botForm" class="hidden">
      <h2>Bot Token</h2>
      <p class="hint">
        Create a bot via @BotFather in Telegram, then enter the token below.
      </p>
      <label>Bot Token
        <input id="f_bot_token" type="text" placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz">
      </label>
      <button class="btn-primary" id="btnBotVerify" onclick="verifyBotToken()">Verify Token</button>
      <div class="btn-row">
        <button class="btn-ghost" onclick="location.href='/'">‚Üê Back</button>
        <button class="btn-primary" id="btnBotSave" onclick="saveBotToken()" disabled>Save Token</button>
      </div>
    </div>

    <div id="botActions" class="hidden">
      <h2>Bot Active</h2>
      <p class="hint" id="botUsernameDisplay"></p>
      <div class="btn-row">
        <button class="btn-ghost" onclick="location.href='/'">‚Üê Back</button>
        <button class="btn-primary" id="btnBotStart" onclick="startBot()">Start Bot</button>
      </div>
    </div>
  </div>
</div>

<script>

const toggleBtn = document.getElementById('themeToggle');
let dark = localStorage.getItem('mcub_theme') !== 'light';

function applyTheme() {
  document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
  toggleBtn.textContent = dark ? 'üåô' : '‚òÄÔ∏è';
  localStorage.setItem('mcub_theme', dark ? 'dark' : 'light');
}
applyTheme();
toggleBtn.onclick = () => { dark = !dark; applyTheme(); };

function dismiss(el) {
  el.style.animation = 'slideOut .25s ease forwards';
  setTimeout(() => el.remove(), 250);
}

function shakeInput(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.remove('shake');
  void el.offsetWidth;
  el.classList.add('shake');
  el.addEventListener('animationend', () => el.classList.remove('shake'), {once:true});
}

function toast(msg, type = 'err') {
  if (type === 'err') {
    const active = document.activeElement;
    if (active && active.tagName === 'INPUT') {
      active.classList.remove('shake'); void active.offsetWidth;
      active.classList.add('shake');
      active.addEventListener('animationend', () => active.classList.remove('shake'), {once:true});
    }
  }
  const MAX_TOASTS = 5;
  const wrap = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = 'toast' + (type === 'ok' ? ' ok' : '');
  el.innerHTML = `<span class="toast-icon">${type === 'ok' ? '‚úì' : '‚ö†'}</span><span>${msg}</span><span class="toast-close">‚úï</span>`;
  wrap.prepend(el);

  while (wrap.children.length > MAX_TOASTS) {
    wrap.lastElementChild.remove();
  }

  setTimeout(() => dismiss(el), 6000);
}

let _currentStep = 1;

function show(n) {
  const wstepMap = {'1':1, '1qr':2, '2':3, '3':4, '4':5, '5':6};
  const stepMap  = {'1':1, '1qr':2, '2':3, '3':4, '4':5, '5':6};

  const wstepIdx = wstepMap[String(n)];
  const stepIdx  = stepMap[String(n)];
  const goingBack = wstepIdx < _currentStep;
  if (wstepIdx !== undefined) _currentStep = wstepIdx;

  if (wstepIdx !== undefined) {
    document.querySelectorAll('.wstep').forEach((el, i) => {
      const visible = i + 1 === wstepIdx;
      el.classList.toggle('hidden', !visible);
      if (visible) {
        el.classList.remove('slide-back');
        void el.offsetWidth;
        if (goingBack) el.classList.add('slide-back');
        else el.classList.remove('slide-back');
      }
    });
  }

  if (stepIdx !== undefined) {
    document.querySelectorAll('.step').forEach((el, i) => {
      el.classList.toggle('active', i + 1 === stepIdx);
      el.classList.toggle('done',   i + 1 < stepIdx);
    });
    document.querySelectorAll('.sconn').forEach((el, i) => {
      el.classList.toggle('filled', i < stepIdx - 1);
    });
  }

  const inp = document.querySelector(`#s${n} input`);
  if (inp) setTimeout(() => inp.focus(), 80);
}

function btnLoading(id, on) {
  const b = document.getElementById(id);
  if (!b) return;
  if (on) { b._label = b.textContent; b.textContent = '‚è≥ Please wait‚Ä¶'; b.disabled = true; }
  else    { b.textContent = b._label || b.textContent; b.disabled = false; }
}

async function post(url, body) {
  const r = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
  return { ok: r.ok, status: r.status, ...(await r.json()) };
}

async function step1() {
  const api_id   = document.getElementById('f_api_id').value.trim();
  const api_hash = document.getElementById('f_api_hash').value.trim();
  const phone    = document.getElementById('f_phone').value.trim();
  if (!api_id || !api_hash || !phone) { toast('All fields are required.'); return; }
  btnLoading('btn1', true);
  try {
    const r = await post('/api/setup/send_code', { api_id, api_hash, phone });
    if (!r.ok) { toast(r.error || 'Unknown error'); return; }
    show(2);
  } catch(e) { toast('Network error: ' + e.message); }
  finally { btnLoading('btn1', false); }
}

async function step2() {
  const code = document.getElementById('f_code').value.trim();
  if (!code) { toast('Please enter the code.'); return; }
  btnLoading('btn2', true);
  try {
    const r = await post('/api/setup/verify_code', { code });
    if (r.requires_2fa) { show(3); return; }
    if (!r.ok) { toast(r.error || 'Unknown error'); return; }
    show(4);
  } catch(e) { toast('Network error: ' + e.message); }
  finally { btnLoading('btn2', false); }
}

async function step3() {
  const password = document.getElementById('f_pass').value;
  if (!password) { toast('Please enter your password.'); return; }
  btnLoading('btn3', true);
  try {
    const r = await post('/api/setup/verify_code', { password });
    if (!r.ok) { toast(r.error || 'Unknown error'); return; }
    show(4);
  } catch(e) { toast('Network error: ' + e.message); }
  finally { btnLoading('btn3', false); }
}

async function step1QR() {
  const api_id   = document.getElementById('f_api_id').value.trim();
  const api_hash = document.getElementById('f_api_hash').value.trim();
  if (!api_id || !api_hash) { toast('API ID and Hash are required.'); return; }
  btnLoading('btn1_qr', true);
  try {
    const r = await post('/api/setup/qr_login', { api_id, api_hash });
    if (!r.ok) { toast(r.error || 'Unknown error'); return; }

    const qrContainer = document.getElementById('qr-image');
    qrContainer.innerHTML = '';
    new QRCode(qrContainer, {
      text: r.qr_url,
      width: 220, height: 220,
      colorDark: '#000', colorLight: '#fff',
      correctLevel: QRCode.CorrectLevel.M
    });
    document.getElementById('qr-status').textContent = 'Scan with your Telegram app...';
    show('1qr');

    pollQRLoop();
  } catch(e) { toast('Network error: ' + e.message); }
  finally { btnLoading('btn1_qr', false); }
}

let qrPollInterval = null;

function pollQRLoop() {
  if (qrPollInterval) clearInterval(qrPollInterval);
  qrPollInterval = setInterval(async () => {
    try {
      const r = await post('/api/setup/qr_poll', {});
      if (r.requires_2fa) {
        clearInterval(qrPollInterval);
        show(3);
        return;
      }
      if (r.qr_expired && r.qr_url) {
        const qrContainer = document.getElementById('qr-image');
        qrContainer.innerHTML = '';
        new QRCode(qrContainer, {
          text: r.qr_url,
          width: 220, height: 220,
          colorDark: '#000', colorLight: '#fff',
          correctLevel: QRCode.CorrectLevel.M
        });
        document.getElementById('qr-status').textContent = 'New QR code generated - scan again!';
        toast('QR code expired, new one generated', 'ok');
        animateQR();
        return;
      }
      if (r.ok && !r.waiting) {
        clearInterval(qrPollInterval);
        show(4);
        return;
      }
      if (r.error) {
        clearInterval(qrPollInterval);
        toast(r.error);
        show(1);
        return;
      }
    } catch(e) {}
  }, 3000);
}

async function pollQR() {
  document.getElementById('qr-status').textContent = 'Checking...';
  try {
    const r = await post('/api/setup/qr_poll', {});
    if (r.requires_2fa) {
      clearInterval(qrPollInterval);
      show(3);
      return;
    }
    if (r.ok && !r.waiting) {
      clearInterval(qrPollInterval);
      show(4);
      return;
    }
    document.getElementById('qr-status').textContent = 'Waiting for scan...';
  } catch(e) {
    document.getElementById('qr-status').textContent = 'Error: ' + e.message;
  }
}

function pollKernel() {
  const st = document.getElementById('poll-status');
  let n = 0;
  const t = setInterval(async () => {
    n++;
    try {
      const r = await fetch('/status');
      if (r.ok) { clearInterval(t); st.textContent='‚úÖ Kernel ready! Redirecting‚Ä¶'; setTimeout(()=>location.href='/',1200); return; }
    } catch(_) {}
    st.textContent = `Waiting for kernel‚Ä¶ (${n})`;
  }, 2000);
}

function showResetChoice() {
  document.getElementById('resetModal').classList.remove('hidden');
}

async function resetAndChoose(method) {
  document.getElementById('resetModal').classList.add('hidden');
  try {
    await fetch('/setup/reset', {method:'GET'});
  } catch(e) {}

  if (method === 'qr') {
    show(1);
    toast('Enter API credentials and click QR Code button', 'ok');
  } else {
    location.reload();
  }
}

document.getElementById('f_phone').addEventListener('keydown',    e => e.key==='Enter' && step1());
document.getElementById('f_code').addEventListener('keydown',     e => e.key==='Enter' && step2());
document.getElementById('f_pass').addEventListener('keydown',     e => e.key==='Enter' && step3());
document.getElementById('f_api_hash').addEventListener('keydown', e => e.key==='Enter' && document.getElementById('f_phone').focus());
document.getElementById('toasts').addEventListener('click', (e) => {
  const closeBtn = e.target.closest('.toast-close');
  if (closeBtn) {
    const toastEl = closeBtn.closest('.toast');
    if (toastEl) dismiss(toastEl);
  }
});

async function verifyBotInSetup() {
  const token = document.getElementById('f_bot_token').value.trim();
  if (!token) {

    document.getElementById('btn4').disabled = false;
    return;
  }
  btnLoading('btn4verify', true);
  try {
    const r = await post('/api/bot/verify_token', { token });
    if (!r.ok || !r.valid) { toast(r.error || 'Invalid token'); return; }
    toast('Token valid! Bot: @' + r.username, 'ok');
    document.getElementById('btn4').disabled = false;
  } catch(e) { toast('Error: ' + e.message); }
  finally { btnLoading('btn4verify', false); }
}

async function autoCreateBot() {
  btnLoading('btn4auto', true);
  try {
    const r = await post('/api/bot/auto_create', {});
    if (!r.ok) {
      if (r.manual) {
        toast('Auto create failed. Enter token manually or skip.', 'err');
      } else {
        toast(r.error || 'Error creating bot');
      }
      return;
    }
    document.getElementById('f_bot_token').value = r.token;
    toast('Bot @' + r.username + ' created! Continue.', 'ok');
    document.getElementById('btn4').disabled = false;
  } catch(e) { toast('Error: ' + e.message); }
  finally { btnLoading('btn4auto', false); }
}

async function skipBot() {
  await post('/api/setup/complete', {});
  show(5); pollKernel();
}

async function finishWithBot() {
  const token = document.getElementById('f_bot_token').value.trim();
  btnLoading('btn4', true);
  try {
    if (token) {
      const r = await post('/api/bot/save_token', { token });
      if (!r.ok) { toast(r.error || 'Error saving token'); return; }
    }

    await post('/api/setup/complete', {});
    show(5); pollKernel();
  } catch(e) { toast('Error: ' + e.message); }
  finally { btnLoading('btn4', false); }
}

async function loadBotStatus() {
  try {
    const r = await fetch('/api/bot/status');
    const data = await r.json();

    document.getElementById('botStatus').classList.add('hidden');

    if (data.running) {
      document.getElementById('botActions').classList.remove('hidden');
      document.getElementById('botUsernameDisplay').textContent = 'Running as @' + data.username;
      document.getElementById('btnBotStart').textContent = 'Running ‚úì';
      document.getElementById('btnBotStart').disabled = true;
    } else if (data.has_token) {
      document.getElementById('botActions').classList.remove('hidden');
      document.getElementById('botUsernameDisplay').textContent = 'Token saved. Click Start to activate.';
      document.getElementById('btnBotStart').disabled = false;
    } else {
      document.getElementById('botForm').classList.remove('hidden');
    }
  } catch(e) {
    document.getElementById('botStatus').innerHTML = '<p class="hint">Error loading status</p>';
  }
}

async function verifyBotToken() {
  const token = document.getElementById('f_bot_token').value.trim();
  if (!token) { toast('Token is required'); return; }

  btnLoading('btnBotVerify', true);
  try {
    const r = await post('/api/bot/verify_token', { token });
    if (!r.ok) { toast(r.error || 'Invalid token'); return; }
    if (r.valid) {
      toast('Token valid! Bot: @' + r.username, 'ok');
      document.getElementById('btnBotSave').disabled = false;
    }
  } catch(e) { toast('Error: ' + e.message); }
  finally { btnLoading('btnBotVerify', false); }
}

async function saveBotToken() {
  const token = document.getElementById('f_bot_token').value.trim();
  btnLoading('btnBotSave', true);
  try {
    const r = await post('/api/bot/save_token', { token });
    if (!r.ok) { toast(r.error || 'Error saving'); return; }
    toast('Token saved! Restart kernel to apply.', 'ok');
    setTimeout(() => location.reload(), 1500);
  } catch(e) { toast('Error: ' + e.message); }
  finally { btnLoading('btnBotSave', false); }
}

async function startBot() {
  btnLoading('btnBotStart', true);
  try {
    const r = await post('/api/bot/start', {});
    if (!r.ok) { toast(r.error || 'Error starting bot'); return; }
    toast('Bot started!', 'ok');
    setTimeout(() => location.reload(), 1500);
  } catch(e) { toast('Error: ' + e.message); }
  finally { btnLoading('btnBotStart', false); }
}

if (location.pathname === '/bot') {
  document.getElementById('setupPage').classList.add('hidden');
  document.getElementById('botPage').classList.remove('hidden');
  loadBotStatus();
}

{% if show_reauth %}
document.getElementById('setupPage').classList.add('hidden');
document.getElementById('reauthPage').classList.remove('hidden');
{% else %}

async function checkReauth() {
  try {
    const r = await fetch('/api/setup/state');
    const state = await r.json();
    if (state.needs_reauth) {
      document.getElementById('setupPage').classList.add('hidden');
      document.getElementById('reauthPage').classList.remove('hidden');
    }
  } catch(e) {}
}
checkReauth();
{% endif %}

async function _prefillFromConfig() {
  try {
    const r = await fetch('/api/setup/prefill');
    const d = await r.json();
    if (d.ok) {
      document.getElementById('f_api_id').value   = d.api_id   || '';
      document.getElementById('f_api_hash').value = d.api_hash || '';
      document.getElementById('f_phone').value    = d.phone    || '';
    }
    return d;
  } catch(e) { return {}; }
}

async function showReauthQR() {
  document.getElementById('reauthPage').classList.add('hidden');
  document.getElementById('setupPage').classList.remove('hidden');
  const d = await _prefillFromConfig();
  if (d.ok && d.api_id && d.api_hash) {
    await step1QR();
  } else {
    show(1);
    toast('Fill in API credentials to continue', 'err');
  }
}

async function showReauthCode() {
  document.getElementById('reauthPage').classList.add('hidden');
  document.getElementById('setupPage').classList.remove('hidden');
  const d = await _prefillFromConfig();
  if (d.ok && d.api_id && d.api_hash && d.phone) {
    await step1();
  } else {
    show(1);
    toast('Fill in API credentials to continue', 'err');
  }
}

document.addEventListener('click', e => {
  const btn = e.target.closest('.btn-primary, .btn-ghost');
  if (!btn) return;
  const r = document.createElement('span');
  r.className = 'ripple';
  const rect = btn.getBoundingClientRect();
  const size = Math.max(rect.width, rect.height);
  r.style.cssText = `width:${size}px;height:${size}px;left:${e.clientX-rect.left-size/2}px;top:${e.clientY-rect.top-size/2}px`;
  btn.appendChild(r);
  r.addEventListener('animationend', () => r.remove());
});

function animateQR() {
  const el = document.getElementById('qr-image');
  el.classList.remove('refreshed'); void el.offsetWidth;
  el.classList.add('refreshed');
}

function rand(a,b){return Math.random()*(b-a)+a;}
document.querySelectorAll('.wish').forEach(el => {
  function shoot() {
    el.style.top = rand(10,80)+'px';
    el.style.left = rand(10,100)+'%';
    el.style.width = rand(40,200)+'px';
    el.style.opacity = 0;
    el.style.animation = 'none';
    el.offsetWidth;
    el.style.animation = `shoot ${rand(1,3)}s ease-in-out forwards`;
    el.addEventListener('animationend', () => setTimeout(shoot, rand(500,5000)), {once:true});
  }
  setTimeout(shoot, rand(0,5000));
});
</script>

<style>
@keyframes shoot{0%{opacity:0;transform:translateX(0);}10%{opacity:1;}80%{opacity:.6;}100%{opacity:0;transform:translateX(-800px);}}
</style>
</body>
</html>
