<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MCUB â€“ Setup</title>
<!-- QR Code library-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Hubballi&family=JetBrains+Mono:wght@300;400;600&display=swap">
<style>
:root {
  --accent:      #7c3aed;
  --accent-glow: #5b21b6;
  --accent-soft: rgba(124,58,237,.18);

  --bg:       #0d0d12;
  --bg2:      #13131a;
  --card:     rgba(20,18,30,.72);
  --border:   rgba(124,58,237,.22);
  --text:     #e8e6f0;
  --text-dim: #6b6880;
  --input-bg: rgba(10,8,18,.7);
  --glow-col: #4c1d95;
  --err-bg:   rgba(127,29,29,.35);
  --err-border:rgba(239,68,68,.4);
  --err-text: #fca5a5;
}
[data-theme="light"] {
  --bg:       #f0eefa;
  --bg2:      #e8e2f7;
  --card:     rgba(255,255,255,.85);
  --border:   rgba(124,58,237,.3);
  --text:     #1e1a2e;
  --text-dim: #8b80a8;
  --input-bg: rgba(255,255,255,.9);
  --glow-col: #c4b5fd;
  --err-bg:   rgba(254,226,226,.8);
  --err-border:rgba(239,68,68,.5);
  --err-text: #b91c1c;
}

*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}

html,body{
  width:100%;height:100%;
  background:var(--bg);
  color:var(--text);
  font-family:Hubballi,sans-serif;
  transition:background .4s,color .4s;
}

.blob{
  position:fixed;inset:0;z-index:0;pointer-events:none;
  background:radial-gradient(ellipse 60% 50% at 50% 60%, var(--glow-col) 0%, transparent 70%);
  opacity:.55;
  transition:background .5s;
}

.lights{
  position:fixed;inset:0;z-index:1;pointer-events:none;overflow:hidden;
  animation:fi .8s ease forwards .5s;opacity:0;
}
.light{
  position:absolute;width:3px;background:#fff;
  top:100vh;left:0;right:0;bottom:0;margin:auto;
  filter:blur(4px);
}
.x1{filter:blur(3px);animation:floatUp 4s infinite linear;}
.x2{filter:blur(3px);animation:floatUp 7s infinite linear;transform:scale(1.6);left:15%;}
.x3{filter:blur(3px);animation:floatUp 2.5s infinite linear;transform:scale(.5);left:-15%;}
.x4{filter:blur(5px);animation:floatUp 4.5s infinite linear;transform:scale(1.2);left:-34%;}
.x5{filter:blur(6px);animation:floatUp 8s infinite linear;transform:scale(2.2);left:-57%;}
.x6{filter:blur(4px);animation:floatUp 3s infinite linear;transform:scale(.8);left:-81%;}
.x7{filter:blur(3px);animation:floatUp 5.3s infinite linear;transform:scale(3.2);left:37%;}
.x8{filter:blur(6px);animation:floatUp 4.7s infinite linear;transform:scale(1.7);left:62%;}
.x9{filter:blur(3px);animation:floatUp 4.1s infinite linear;transform:scale(.9);left:85%;}

@keyframes floatUp{
  0%{top:100vh;opacity:0;}25%{opacity:1;}50%{top:0;opacity:.8;}75%{opacity:1;}100%{top:-100vh;opacity:0;}
}
@keyframes fi{to{opacity:1;}}

#sky{position:fixed;inset:0;overflow:hidden;z-index:1;pointer-events:none;}
#shootingstars{
  position:fixed;overflow:hidden;
  width:150vh;height:100vw;
  transform:translateX(calc(50vw - 50%)) translateY(calc(50vh - 50%)) rotate(120deg);
}
.wish{
  height:2px;width:100px;top:300px;
  position:absolute;opacity:0;
  background:linear-gradient(-45deg,#fff,rgba(0,0,255,0));
  filter:drop-shadow(0 0 6px #fff);
}

/* â”€â”€ Top-right controls â”€â”€ */
.top-controls{
  position:fixed;top:18px;right:18px;z-index:999;
  display:flex;gap:8px;align-items:center;
}
.icon-btn{
  width:38px;height:38px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:50%;
  cursor:pointer;
  display:flex;align-items:center;justify-content:center;
  font-size:1rem;
  backdrop-filter:blur(8px);
  transition:border-color .2s,box-shadow .2s,background .3s;
  user-select:none;
  font-family:'JetBrains Mono',monospace;font-weight:600;
  color:var(--text-dim);
}
.icon-btn:hover{
  border-color:var(--accent);
  box-shadow:0 0 14px -4px var(--accent);
  color:var(--text);
}

#toasts{
  position:fixed;top:18px;left:18px;z-index:9999;
  display:flex;flex-direction:column;gap:8px;
  max-width:340px;
}
.toast{
  display:flex;align-items:flex-start;gap:10px;
  padding:11px 14px;
  background:var(--err-bg);
  border:1px solid var(--err-border);
  border-radius:7px;
  backdrop-filter:blur(10px);
  font-family:'JetBrains Mono',monospace;
  font-size:.76rem;
  color:var(--err-text);
  line-height:1.45;
  animation:slideIn .25s ease;
  cursor:pointer;
}
.toast.ok{
  background:rgba(5,46,22,.4);
  border-color:rgba(34,197,94,.4);
  color:#86efac;
}
.toast-icon{flex-shrink:0;margin-top:1px;}
.toast-close{margin-left:auto;flex-shrink:0;opacity:.5;padding-left:6px;}
@keyframes slideIn{from{opacity:0;transform:translateX(-18px);}to{opacity:1;transform:none;}}
@keyframes slideOut{to{opacity:0;transform:translateX(-18px);}}

.page{
  min-height:100vh;
  display:flex;flex-direction:column;
  align-items:center;
  justify-content:center;
  padding:30px 16px 40px;
  position:relative;z-index:2;
}

.logo-row{
  display:flex;align-items:center;gap:14px;
  margin-bottom:6px;
}
.logo-img{
    height:2rem;
    width:auto;
    object-fit:contain;
}
.logo-text{
  font-family:'JetBrains Mono',monospace;
  font-size:2rem;font-weight:600;
  letter-spacing:.18em;
  color:var(--accent);
  text-shadow:0 0 24px var(--accent);
}
.subtitle{
  font-size:.88rem;color:var(--text-dim);
  text-align:center;margin-bottom:18px;
}

.steps-bar{
  display:flex;align-items:center;
  justify-content:center;
  margin-bottom:18px;
}
.step{display:flex;flex-direction:column;align-items:center;gap:3px;opacity:.35;transition:opacity .25s;}
.step.active,.step.done{opacity:1;}
.snum{
  width:28px;height:28px;border-radius:50%;
  border:1px solid var(--text-dim);color:var(--text-dim);
  display:flex;align-items:center;justify-content:center;
  font-family:'JetBrains Mono',monospace;font-weight:600;font-size:.78em;
  transition:background .25s,border-color .25s,color .25s;
}
.step.active .snum{background:var(--accent);border-color:var(--accent);color:#fff;box-shadow:0 0 12px var(--accent);}
.step.done   .snum{background:#16a34a;border-color:#16a34a;color:#fff;}
.slabel{font-size:.65em;color:var(--text-dim);white-space:nowrap;}
.step.active .slabel,.step.done .slabel{color:var(--text);}
.sconn{flex:1;height:1px;background:var(--border);min-width:28px;margin-bottom:14px;}

.wizard-card{
  width:100%;max-width:460px;
  background:var(--card);
  border:1px solid var(--border);
  border-radius:10px;
  padding:28px 30px;
  backdrop-filter:blur(12px);
  box-shadow:0 8px 48px -12px rgba(124,58,237,.25);
  transition:background .3s,border-color .3s;
}
.wstep h2{font-size:1.25rem;color:var(--text);margin-bottom:5px;}
.hint{font-size:.83rem;color:var(--text-dim);line-height:1.55;margin-bottom:18px;}
.hint a{color:var(--accent);text-decoration:none;}
.hint.small{font-size:.76rem;}

label{
  display:flex;flex-direction:column;gap:5px;
  margin-bottom:13px;
  font-family:'JetBrains Mono',monospace;
  font-size:.75rem;color:var(--text-dim);letter-spacing:.04em;
}
input[type=text],input[type=tel],input[type=password]{
  width:100%;padding:9px 12px;
  background:var(--input-bg);
  border:1px solid var(--border);
  border-radius:5px;
  color:var(--text);
  font-family:'JetBrains Mono',monospace;font-size:.9rem;
  outline:none;
  transition:border-color .2s,box-shadow .2s,background .3s;
}
input:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 3px var(--accent-soft);
}
input::placeholder{color:var(--text-dim);opacity:.55;}

.btn-primary{
  width:100%;padding:10px 16px;
  background:transparent;
  color:var(--accent);
  border:1px solid var(--accent);
  border-radius:6px;
  font-family:'JetBrains Mono',monospace;font-size:.88rem;
  cursor:pointer;
  transition:background .2s,color .2s,box-shadow .2s,transform .1s;
  margin-top:0;
  white-space:nowrap;
}
.btn-primary:hover:not(:disabled){
  background:var(--accent);color:#fff;
  box-shadow:0 0 20px -6px var(--accent);
}
.btn-primary:active:not(:disabled){ transform:scale(.97); }
.btn-primary:disabled{opacity:.35;cursor:not-allowed;}

.btn-ghost{
  width:100%;padding:10px 16px;
  background:transparent;color:var(--text-dim);
  border:1px solid var(--border);border-radius:6px;
  font-family:'JetBrains Mono',monospace;font-size:.88rem;
  cursor:pointer;transition:border-color .2s,color .2s,transform .1s;
  white-space:nowrap;
}
.btn-ghost:hover{ border-color:var(--text-dim);color:var(--text); }
.btn-ghost:active{ transform:scale(.97); }

.btn-row{ display:flex; gap:8px; margin-top:8px; }
.btn-row > button { flex:1; margin:0; }

.wstep > .btn-primary,
.wstep > .btn-ghost { margin-bottom:8px; }

.done-icon{font-size:2.8rem;text-align:center;margin-bottom:6px;}
.spinner{
  width:30px;height:30px;
  border:2px solid var(--border);border-top-color:var(--accent);
  border-radius:50%;animation:spin .7s linear infinite;margin:14px auto;
}
@keyframes spin{to{transform:rotate(360deg);}}

.reset-bar{
  font-family:'JetBrains Mono',monospace;
  font-size:.68rem;color:var(--text-dim);
  text-align:center;margin-bottom:12px;
}
.reset-link{color:var(--text-dim);text-decoration:none;transition:color .2s;}
.reset-link:hover{color:var(--accent);}

.setup-footer{
  margin-top:18px;
  font-size:.72rem;color:var(--text-dim);
  font-family:Hubballi;
}

.hidden{display:none!important;}

.page { animation: pageFadeUp .55s cubic-bezier(.22,1,.36,1) both; }
@keyframes pageFadeUp {
  from { opacity:0; transform:translateY(22px); }
  to   { opacity:1; transform:none; }
}

.wizard-card { animation: cardPop .5s cubic-bezier(.22,1,.36,1) .1s both; }
@keyframes cardPop {
  from { opacity:0; transform:scale(.96) translateY(12px); }
  to   { opacity:1; transform:none; }
}

.wstep { animation: stepIn .32s cubic-bezier(.22,1,.36,1) both; }
@keyframes stepIn {
  from { opacity:0; transform:translateX(18px); }
  to   { opacity:1; transform:none; }
}
.wstep.slide-back { animation: stepInBack .32s cubic-bezier(.22,1,.36,1) both; }
@keyframes stepInBack {
  from { opacity:0; transform:translateX(-18px); }
  to   { opacity:1; transform:none; }
}

.logo-img {
  animation: logoPulse 3s ease-in-out infinite;
  filter: drop-shadow(0 0 0px var(--accent));
}
@keyframes logoPulse {
  0%,100% { filter: drop-shadow(0 0 4px var(--accent)) drop-shadow(0 0 0px var(--accent-glow)); }
  50%      { filter: drop-shadow(0 0 14px var(--accent)) drop-shadow(0 0 8px var(--accent-glow)); }
}

.step.active .snum { animation: dotBounce .35s cubic-bezier(.34,1.56,.64,1); }
@keyframes dotBounce {
  from { transform: scale(.6); }
  to   { transform: scale(1); }
}

.sconn { position:relative; overflow:hidden; }
.sconn::after {
  content:''; position:absolute; inset:0;
  background:var(--accent);
  transform:scaleX(0); transform-origin:left;
  transition:transform .4s ease;
}
.sconn.filled::after { transform:scaleX(1); }

.blob { animation: blobDrift 8s ease-in-out infinite alternate; }
@keyframes blobDrift {
  from { background-position: 40% 55%; transform: scale(1); }
  to   { background-position: 60% 65%; transform: scale(1.06); }
}

@keyframes inputShake {
  0%,100% { transform:none; }
  20%     { transform:translateX(-6px); }
  40%     { transform:translateX(6px); }
  60%     { transform:translateX(-4px); }
  80%     { transform:translateX(4px); }
}
input.shake { animation: inputShake .4s ease; border-color: rgba(239,68,68,.8) !important; }

.done-icon img { animation: successBounce .6s cubic-bezier(.34,1.56,.64,1) .1s both; }
@keyframes successBounce {
  from { transform:scale(0) rotate(-20deg); opacity:0; }
  to   { transform:scale(1) rotate(0); opacity:1; }
}

#resetModal { transition: opacity .2s; }
#resetModal > div { animation: modalPop .25s cubic-bezier(.22,1,.36,1); }
@keyframes modalPop {
  from { transform:scale(.92); opacity:0; }
  to   { transform:none; opacity:1; }
}

#qr-image { animation: qrFadeIn .4s ease .1s both; }
@keyframes qrFadeIn {
  from { opacity:0; transform:scale(.9); }
  to   { opacity:1; transform:none; }
}

#qr-image.refreshed { animation: qrFadeIn .3s ease both; }

.btn-primary, .btn-ghost {
  position: relative; overflow: hidden;
}
.ripple {
  position:absolute; border-radius:50%;
  background:rgba(255,255,255,.25);
  transform:scale(0);
  animation:rippleAnim .5s linear;
  pointer-events:none;
}
@keyframes rippleAnim {
  to { transform:scale(4); opacity:0; }
}

#reauthPage .wizard-card { animation: cardPop .5s cubic-bezier(.22,1,.36,1) .15s both; }

@media(max-width:520px){
  .wizard-card{padding:20px 16px;}
  .slabel{display:none;}
  .sconn{min-width:16px;}
}
</style>
</head>
<body>

<!-- bg -->
<div class="blob"></div>
<div class="lights">
  <div class="light x1"></div><div class="light x2"></div><div class="light x3"></div>
  <div class="light x4"></div><div class="light x5"></div><div class="light x6"></div>
  <div class="light x7"></div><div class="light x8"></div><div class="light x9"></div>
</div>
<div id="sky"><div id="shootingstars">
  <div class="wish"></div><div class="wish"></div><div class="wish"></div>
  <div class="wish"></div><div class="wish"></div><div class="wish"></div>
  <div class="wish"></div><div class="wish"></div><div class="wish"></div>
  <div class="wish"></div>
</div></div>

<!-- â”€â”€ Top-right controls: lang + theme â”€â”€ -->
<div class="top-controls">
  <button class="icon-btn" id="langToggle" title="Switch language">EN</button>
  <button class="icon-btn" id="themeToggle" title="Toggle theme">ğŸŒ™</button>
</div>

<div id="toasts"></div>

<div class="page" id="setupPage">

  <div class="logo-row">
    <img src="/static/img/0.png" alt="MCUB" class="logo-img">
  </div>
  <p class="subtitle" data-i18n="subtitle_setup"></p>

  <div class="steps-bar">
    <div class="step active" id="dot-1"><span class="snum">1</span><span class="slabel" data-i18n="step_credentials"></span></div>
    <div class="sconn"></div>
    <div class="step" id="dot-1qr"><span class="snum">QR</span><span class="slabel" data-i18n="step_scan"></span></div>
    <div class="sconn"></div>
    <div class="step" id="dot-2"><span class="snum">2</span><span class="slabel" data-i18n="step_code"></span></div>
    <div class="sconn"></div>
    <div class="step" id="dot-3"><span class="snum">3</span><span class="slabel">2FA</span></div>
    <div class="sconn"></div>
    <div class="step" id="dot-4"><span class="snum">4</span><span class="slabel" data-i18n="step_bot"></span></div>
    <div class="sconn"></div>
    <div class="step" id="dot-5"><span class="snum">5</span><span class="slabel" data-i18n="step_done"></span></div>
  </div>

  <div class="wizard-card">

    <!-- Step 1 -->
    <div class="wstep" id="s1">
      <h2 data-i18n="s1_title"></h2>
      <p class="hint" data-i18n-html="s1_hint"></p>
      <label>
        <span data-i18n="label_api_id"></span>
        <input id="f_api_id" type="text" inputmode="numeric" placeholder="12345678" autocomplete="off">
      </label>
      <label>
        <span data-i18n="label_api_hash"></span>
        <input id="f_api_hash" type="text" placeholder="0123456789abcdefâ€¦" autocomplete="off">
      </label>
      <label>
        <span data-i18n="label_phone"></span>
        <input id="f_phone" type="tel" placeholder="+1234567890" autocomplete="tel">
      </label>
      <div class="btn-row">
        <button class="btn-primary" id="btn1" onclick="step1()" data-i18n="btn_send_code"></button>
        <button class="btn-ghost" id="btn1_qr" onclick="step1QR()" data-i18n="btn_qr_code"></button>
      </div>
    </div>

    <!-- Step 1.5: QR Code -->
    <div class="wstep hidden" id="s1qr">
      <h2 data-i18n="s1qr_title"></h2>
      <p class="hint" data-i18n="s1qr_hint"></p>
      <div id="qr-container" style="text-align:center;margin:20px 0;">
        <div id="qr-image" style="display:inline-block;padding:12px;background:#fff;border-radius:8px;"></div>
      </div>
      <p class="hint small" id="qr-status" data-i18n="qr_waiting"></p>
      <div class="btn-row">
        <button class="btn-ghost" onclick="show(1)" data-i18n="btn_back"></button>
        <button class="btn-primary" id="btn_qr_poll" onclick="pollQR()" data-i18n="btn_check_again"></button>
      </div>
    </div>

    <!-- Step 2 -->
    <div class="wstep hidden" id="s2">
      <h2 data-i18n="s2_title"></h2>
      <p class="hint" data-i18n="s2_hint"></p>
      <label>
        <span data-i18n="label_code"></span>
        <input id="f_code" type="text" inputmode="numeric" placeholder="12345" autocomplete="one-time-code" maxlength="10">
      </label>
      <div class="btn-row">
        <button class="btn-ghost" onclick="show(1)" data-i18n="btn_back_arrow"></button>
        <button class="btn-primary" id="btn2" onclick="step2()" data-i18n="btn_verify"></button>
      </div>
    </div>

    <!-- Step 3 -->
    <div class="wstep hidden" id="s3">
      <h2 data-i18n="s3_title"></h2>
      <p class="hint" data-i18n="s3_hint"></p>
      <label>
        <span data-i18n="label_cloud_password"></span>
        <input id="f_pass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password">
      </label>
      <div class="btn-row">
        <button class="btn-ghost" onclick="show(2)" data-i18n="btn_back_arrow"></button>
        <button class="btn-primary" id="btn3" onclick="step3()" data-i18n="btn_confirm"></button>
      </div>
    </div>

    <!-- Step 4: Bot -->
    <div class="wstep hidden" id="s4">
      <h2 data-i18n="s4_title"></h2>
      <p class="hint" data-i18n-html="s4_hint"></p>
      <label>
        <span data-i18n="label_bot_token_skip"></span>
        <input id="f_bot_token" type="text" placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz">
      </label>
      <button class="btn-primary" id="btn4verify" onclick="verifyBotInSetup()" data-i18n="btn_verify_token"></button>
      <button class="btn-ghost" id="btn4auto" onclick="autoCreateBot()" data-i18n="btn_auto_create"></button>
      <div class="btn-row">
        <button class="btn-ghost" onclick="skipBot()" data-i18n="btn_skip"></button>
        <button class="btn-primary" id="btn4" onclick="finishWithBot()" disabled data-i18n="btn_continue"></button>
      </div>
    </div>

    <!-- Step 5 -->
    <div class="wstep hidden" id="s5">
      <div class="done-icon"><img src="/static/img/success.png" alt="Success" style="width:60px;height:60px;"></div>
      <h2 data-i18n="s5_title"></h2>
      <p class="hint" data-i18n="s5_hint"></p>
      <div class="spinner"></div>
      <p class="hint small" id="poll-status" data-i18n="kernel_waiting"></p>
    </div>

  </div>

  <div class="reset-bar">
    <span data-i18n="reset_configured"></span> <a href="#" class="reset-link" onclick="showResetChoice();return false;" data-i18n="reset_link"></a>
  </div>
  <div class="reset-bar" style="margin-top:8px;">
    <a href="/bot" class="reset-link" data-i18n="bot_settings_link"></a>
  </div>

  <!-- Reset modal: note â€” uses display:flex via inline style; .hidden class overrides with !important -->
  <div id="resetModal" class="hidden" style="position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.7);">
    <div style="background:var(--card);border:1px solid var(--border);border-radius:10px;padding:24px;max-width:360px;width:90%;">
      <h3 style="margin-bottom:12px;" data-i18n="modal_title"></h3>
      <p class="hint" style="margin-bottom:18px;" data-i18n="modal_hint"></p>
      <button class="btn-primary" onclick="resetAndChoose('qr')" data-i18n="modal_qr"></button>
      <div class="btn-row" style="margin-top:8px;">
        <button class="btn-ghost" onclick="resetAndChoose('code')" data-i18n="modal_code"></button>
        <button class="btn-ghost" onclick="document.getElementById('resetModal').classList.add('hidden')" data-i18n="btn_cancel"></button>
      </div>
    </div>
  </div>

  <footer class="setup-footer" data-i18n="footer"></footer>
</div>

<div class="page hidden" id="configuredPage">
  <div class="logo-row">
    <img src="/static/img/0.png" alt="MCUB" class="logo-img">
  </div>
  <p class="subtitle" data-i18n="configured_subtitle"></p>

  <div class="wizard-card">
    <div class="done-icon"><img src="/static/img/success.png" alt="Success" style="width:60px;height:60px;"></div>
    <h2 data-i18n="configured_title"></h2>
    <p class="hint" data-i18n="configured_hint"></p>
  </div>

  <div class="reset-bar">
    <a href="/setup/reset" class="reset-link" data-i18n="reset_fresh"></a>
  </div>
  <footer class="setup-footer" data-i18n="footer"></footer>
</div>

<div class="page hidden" id="reauthPage">
  <div class="logo-row">
    <img src="/static/img/0.png" alt="MCUB" class="logo-img">
  </div>
  <p class="subtitle" data-i18n="subtitle_reauth"></p>

  <div class="wizard-card">
    <h2 data-i18n="reauth_title"></h2>
    <p class="hint" data-i18n="reauth_hint"></p>
    <div class="btn-row" style="margin-top:20px;">
      <button class="btn-primary" onclick="showReauthQR()" data-i18n="btn_qr_code"></button>
      <button class="btn-ghost" onclick="showReauthCode()" data-i18n="btn_send_code"></button>
    </div>
  </div>

  <div class="reset-bar">
    <a href="/setup/reset" class="reset-link" data-i18n="reset_fresh"></a>
  </div>
  <footer class="setup-footer" data-i18n="footer"></footer>
</div>

<!-- Bot Settings Page -->
<div class="page hidden" id="botPage">

  <div class="logo-row">
    <img src="/static/img/0.png" alt="MCUB" class="logo-img">
  </div>
  <p class="subtitle" data-i18n="subtitle_bot"></p>

  <div class="wizard-card">
    <div id="botStatus">
      <div class="spinner"></div>
      <p class="hint" data-i18n="loading"></p>
    </div>

    <!-- FIX: was duplicate ID "f_bot_token" â€” renamed to "f_bot_token_page" -->
    <div id="botForm" class="hidden">
      <h2 data-i18n="bot_form_title"></h2>
      <p class="hint" data-i18n="bot_form_hint"></p>
      <label>
        <span data-i18n="label_bot_token"></span>
        <input id="f_bot_token_page" type="text" placeholder="1234567890:ABCdefGHIjklMNOpqrsTUVwxyz">
      </label>
      <button class="btn-primary" id="btnBotVerify" onclick="verifyBotToken()" data-i18n="btn_verify_token"></button>
      <div class="btn-row">
        <button class="btn-ghost" onclick="location.href='/'" data-i18n="btn_back_arrow"></button>
        <button class="btn-primary" id="btnBotSave" onclick="saveBotToken()" disabled data-i18n="btn_save_token"></button>
      </div>
    </div>

    <div id="botActions" class="hidden">
      <h2 data-i18n="bot_active_title"></h2>
      <p class="hint" id="botUsernameDisplay"></p>
      <div class="btn-row">
        <button class="btn-ghost" onclick="location.href='/'" data-i18n="btn_back_arrow"></button>
        <button class="btn-primary" id="btnBotStart" onclick="startBot()" data-i18n="btn_start_bot"></button>
      </div>
    </div>
  </div>
</div>

<script>

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   i18n â€” translations
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TRANSLATIONS = {
  en: {
    // page subtitles
    subtitle_setup:       'First-time setup',
    configured_subtitle:  'MCUB is already configured',
    configured_title:     'Welcome to MCUB!',
    configured_hint:      'Your instance is already configured and ready to use.',
    subtitle_reauth:      'Session Expired',
    subtitle_bot:         'Inline Bot Settings',
    // step labels
    step_credentials:     'Credentials',
    step_scan:            'Scan',
    step_code:            'Code',
    step_bot:             'Bot',
    step_done:            'Done',
    // step 1
    s1_title:             'API Credentials',
    s1_hint:              'Open <a href="https://my.telegram.org" target="_blank">my.telegram.org</a> â†’ API development tools â†’ create app â†’ paste values below.',
    label_api_id:         'API ID',
    label_api_hash:       'API Hash',
    label_phone:          'Phone number',
    btn_send_code:        'Send code',
    btn_qr_code:          'QR Code',
    // step 1qr
    s1qr_title:           'Scan QR Code',
    s1qr_hint:            'Scan this QR code with your Telegram app to log in.',
    qr_waiting:           'Waiting for scan...',
    btn_back:             'Back',
    btn_check_again:      'Check Again',
    // step 2
    s2_title:             'Telegram Code',
    s2_hint:              'A code was sent to your Telegram account. Enter it below.',
    label_code:           'Code',
    btn_back_arrow:       'â† Back',
    btn_verify:           'Verify â†’',
    // step 3
    s3_title:             'Two-Factor Auth',
    s3_hint:              'Your account has 2FA enabled. Enter your cloud password.',
    label_cloud_password: 'Cloud password',
    btn_confirm:          'Confirm â†’',
    // step 4
    s4_title:             'Inline Bot (Optional)',
    s4_hint:              'Create a bot via @BotFather for inline buttons support.<br>Or skip this step and create bot later in settings.',
    label_bot_token_skip: 'Bot Token (leave empty to skip)',
    btn_verify_token:     'Verify Token',
    btn_auto_create:      'Auto Create Bot',
    btn_skip:             'Skip â†’',
    btn_continue:         'Continue â†’',
    // step 5
    s5_title:             'MCUB is installed!',
    s5_hint:              'Kernel is starting â€” redirecting to dashboardâ€¦',
    kernel_waiting:       'Waiting for kernelâ€¦',
    kernel_ready:         'âœ… Kernel ready! Redirectingâ€¦',
    kernel_poll:          'Waiting for kernelâ€¦ ({n})',
    // reset bar
    reset_configured:     'Already configured?',
    reset_link:           'Reset & reconfigure',
    bot_settings_link:    'Bot Settings',
    reset_fresh:          'Reset & start fresh',
    // modal
    modal_title:          'Choose Login Method',
    modal_hint:           'How would you like to log in to your Telegram account?',
    modal_qr:             'Login via QR Code',
    modal_code:           'Send Code',
    btn_cancel:           'Cancel',
    // footer
    footer:               'MCUB Kernel â€“ setup wizard',
    // reauth
    reauth_title:         'Re-authenticate',
    reauth_hint:          'Your session has expired. Please log in again to continue.',
    // bot page
    bot_form_title:       'Bot Token',
    bot_form_hint:        'Create a bot via @BotFather in Telegram, then enter the token below.',
    label_bot_token:      'Bot Token',
    btn_save_token:       'Save Token',
    bot_active_title:     'Bot Active',
    btn_start_bot:        'Start Bot',
    // misc
    loading:              'Loading...',
    // JS toast strings
    err_fields_required:  'All fields are required.',
    err_api_required:     'API ID and Hash are required.',
    err_enter_code:       'Please enter the code.',
    err_enter_password:   'Please enter your password.',
    err_token_required:   'Token is required',
    err_invalid_token:    'Invalid token',
    err_saving:           'Error saving',
    err_unknown:          'Unknown error',
    err_network:          'Network error: ',
    err_auto_create:      'Auto create failed. Enter token manually or skip.',
    err_bot_start:        'Error starting bot',
    err_bot_create:       'Error creating bot',
    err_loading_status:   'Error loading status',
    err_fill_credentials: 'Fill in API credentials to continue',
    ok_token_valid:       'Token valid! Bot: @{username}',
    ok_bot_created:       'Bot @{username} created! Continue.',
    ok_bot_started:       'Bot started!',
    ok_token_saved:       'Token saved! Restart kernel to apply.',
    ok_qr_regenerated:    'QR code expired, new one generated',
    ok_enter_credentials: 'Enter API credentials and click QR Code button',
    qr_scan_app:          'Scan with your Telegram app...',
    qr_new_generated:     'New QR code generated â€” scan again!',
    qr_checking:          'Checking...',
    btn_please_wait:      'â³ Please waitâ€¦',
  },

  ru: {
    // page subtitles
    subtitle_setup:       'ĞŸĞµÑ€Ğ²Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°',
    configured_subtitle:  'MCUB ÑƒĞ¶Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½',
    configured_title:     'Ğ”Ğ¾Ğ±Ñ€Ğ¾ Ğ¿Ğ¾Ğ¶Ğ°Ğ»Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ² MCUB!',
    configured_hint:      'Ğ’Ğ°Ñˆ ÑĞºĞ·ĞµĞ¼Ğ¿Ğ»ÑÑ€ ÑƒĞ¶Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½ Ğ¸ Ğ³Ğ¾Ñ‚Ğ¾Ğ² Ğº Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ.',
    subtitle_reauth:      'Ğ¡ĞµÑÑĞ¸Ñ Ğ¸ÑÑ‚ĞµĞºĞ»Ğ°',
    subtitle_bot:         'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ±Ğ¾Ñ‚Ğ°',
    // step labels
    step_credentials:     'Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ',
    step_scan:            'Ğ¡ĞºĞ°Ğ½',
    step_code:            'ĞšĞ¾Ğ´',
    step_bot:             'Ğ‘Ğ¾Ñ‚',
    step_done:            'Ğ“Ğ¾Ñ‚Ğ¾Ğ²Ğ¾',
    // step 1
    s1_title:             'API Credentials',
    s1_hint:              'ĞÑ‚ĞºÑ€Ğ¾Ğ¹Ñ‚Ğµ <a href="https://my.telegram.org" target="_blank">my.telegram.org</a> â†’ API development tools â†’ ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ â†’ Ğ²ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ğ·Ğ½Ğ°Ñ‡ĞµĞ½Ğ¸Ñ Ğ½Ğ¸Ğ¶Ğµ.',
    label_api_id:         'API ID',
    label_api_hash:       'API Hash',
    label_phone:          'ĞĞ¾Ğ¼ĞµÑ€ Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½Ğ°',
    btn_send_code:        'ĞÑ‚Ğ¿Ñ€Ğ°Ğ²Ğ¸Ñ‚ÑŒ',
    btn_qr_code:          'QR-ĞºĞ¾Ğ´',
    // step 1qr
    s1qr_title:           'Ğ¡ĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ QR-ĞºĞ¾Ğ´',
    s1qr_hint:            'ĞÑ‚ÑĞºĞ°Ğ½Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ QR-ĞºĞ¾Ğ´ Ğ² Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¸ Telegram Ğ´Ğ»Ñ Ğ²Ñ…Ğ¾Ğ´Ğ°.',
    qr_waiting:           'ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞºĞ°Ğ½Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ...',
    btn_back:             'ĞĞ°Ğ·Ğ°Ğ´',
    btn_check_again:      'ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑĞ½Ğ¾Ğ²Ğ°',
    // step 2
    s2_title:             'ĞšĞ¾Ğ´ Ğ¸Ğ· Telegram',
    s2_hint:              'ĞšĞ¾Ğ´ Ğ±Ñ‹Ğ» Ğ¾Ñ‚Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½ Ğ² Ğ²Ğ°Ñˆ Telegram. Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞµĞ³Ğ¾ Ğ½Ğ¸Ğ¶Ğµ.',
    label_code:           'ĞšĞ¾Ğ´',
    btn_back_arrow:       'â† ĞĞ°Ğ·Ğ°Ğ´',
    btn_verify:           'Ğ”Ğ°Ğ»ĞµĞµ â†’',
    // step 3
    s3_title:             'Ğ”Ğ²ÑƒÑ…Ñ„Ğ°ĞºÑ‚Ğ¾Ñ€Ğ½Ğ°Ñ Ğ°ÑƒÑ‚ĞµĞ½Ñ‚Ğ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ',
    s3_hint:              'ĞĞ° Ğ²Ğ°ÑˆĞµĞ¼ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚Ğµ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ° 2FA. Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¾Ğ±Ğ»Ğ°Ñ‡Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ.',
    label_cloud_password: 'ĞĞ±Ğ»Ğ°Ñ‡Ğ½Ñ‹Ğ¹ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ',
    btn_confirm:          'Ğ”Ğ°Ğ»ĞµĞµ â†’',
    // step 4
    s4_title:             'Ğ’ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ±Ğ¾Ñ‚ (Ğ½ĞµĞ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ğ¾)',
    s4_hint:              'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ±Ğ¾Ñ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· @BotFather Ğ´Ğ»Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ¸ Ğ¸Ğ½Ğ»Ğ°Ğ¹Ğ½-ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº.<br>Ğ˜Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ ÑÑ‚Ğ¾Ñ‚ ÑˆĞ°Ğ³ Ğ¸ ÑĞ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ±Ğ¾Ñ‚Ğ° Ğ¿Ğ¾Ğ·Ğ¶Ğµ Ğ² Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ°Ñ….',
    label_bot_token_skip: 'Ğ¢Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ° (Ğ¾ÑÑ‚Ğ°Ğ²ÑŒÑ‚Ğµ Ğ¿ÑƒÑÑ‚Ñ‹Ğ¼, Ñ‡Ñ‚Ğ¾Ğ±Ñ‹ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ)',
    btn_verify_token:     'ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ',
    btn_auto_create:      'ĞĞ²Ñ‚Ğ¾-ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ±Ğ¾Ñ‚Ğ°',
    btn_skip:             'ĞŸÑ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ â†’',
    btn_continue:         'ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ¸Ñ‚ÑŒ â†’',
    // step 5
    s5_title:             'MCUB ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½!',
    s5_hint:              'Ğ¯Ğ´Ñ€Ğ¾ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ÑÑ â€” Ğ¿ĞµÑ€ĞµÑ…Ğ¾Ğ´ Ğº Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñâ€¦',
    kernel_waiting:       'ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞ´Ñ€Ğ°â€¦',
    kernel_ready:         'âœ… Ğ¯Ğ´Ñ€Ğ¾ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾! ĞŸĞµÑ€ĞµĞ½Ğ°Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµâ€¦',
    kernel_poll:          'ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ ÑĞ´Ñ€Ğ°â€¦ ({n})',
    // reset bar
    reset_configured:     'Ğ£Ğ¶Ğµ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾ĞµĞ½Ğ¾?',
    reset_link:           'Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ¸ Ğ¿ĞµÑ€ĞµĞ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ',
    bot_settings_link:    'ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ±Ğ¾Ñ‚Ğ°',
    reset_fresh:          'Ğ¡Ğ±Ñ€Ğ¾ÑĞ¸Ñ‚ÑŒ Ğ¸ Ğ½Ğ°Ñ‡Ğ°Ñ‚ÑŒ Ğ·Ğ°Ğ½Ğ¾Ğ²Ğ¾',
    // modal
    modal_title:          'Ğ’Ñ‹Ğ±ĞµÑ€Ğ¸Ñ‚Ğµ ÑĞ¿Ğ¾ÑĞ¾Ğ± Ğ²Ñ…Ğ¾Ğ´Ğ°',
    modal_hint:           'ĞšĞ°Ğº Ğ²Ñ‹ Ñ…Ğ¾Ñ‚Ğ¸Ñ‚Ğµ Ğ²Ğ¾Ğ¹Ñ‚Ğ¸ Ğ² ÑĞ²Ğ¾Ğ¹ Ğ°ĞºĞºĞ°ÑƒĞ½Ñ‚ Telegram?',
    modal_qr:             'Ğ’Ğ¾Ğ¹Ñ‚Ğ¸ Ğ¿Ğ¾ QR',
    modal_code:           'ĞšĞ¾Ğ´ Ğ½Ğ° Ñ‚ĞµĞ»ĞµÑ„Ğ¾Ğ½',
    btn_cancel:           'ĞÑ‚Ğ¼ĞµĞ½Ğ°',
    // footer
    footer:               'MCUB Kernel â€“ Ğ¼Ğ°ÑÑ‚ĞµÑ€ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸',
    // reauth
    reauth_title:         'ĞŸĞ¾Ğ²Ñ‚Ğ¾Ñ€Ğ½Ğ°Ñ Ğ°Ğ²Ñ‚Ğ¾Ñ€Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ',
    reauth_hint:          'Ğ’Ğ°ÑˆĞ° ÑĞµÑÑĞ¸Ñ Ğ¸ÑÑ‚ĞµĞºĞ»Ğ°. ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ¾Ğ¹Ğ´Ğ¸Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ° Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ñ.',
    // bot page
    bot_form_title:       'Ğ¢Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ°',
    bot_form_hint:        'Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ¹Ñ‚Ğµ Ğ±Ğ¾Ñ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· @BotFather Ğ² Telegram, Ğ·Ğ°Ñ‚ĞµĞ¼ Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‚Ğ¾ĞºĞµĞ½ Ğ½Ğ¸Ğ¶Ğµ.',
    label_bot_token:      'Ğ¢Ğ¾ĞºĞµĞ½ Ğ±Ğ¾Ñ‚Ğ°',
    btn_save_token:       'Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½Ğ¸Ñ‚ÑŒ',
    bot_active_title:     'Ğ‘Ğ¾Ñ‚ Ğ°ĞºÑ‚Ğ¸Ğ²ĞµĞ½',
    btn_start_bot:        'Ğ—Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ',
    // misc
    loading:              'Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°...',
    // JS toast strings
    err_fields_required:  'Ğ’ÑĞµ Ğ¿Ğ¾Ğ»Ñ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ÑŒĞ½Ñ‹ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ.',
    err_api_required:     'ĞĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹ API ID Ğ¸ Hash.',
    err_enter_code:       'ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ ĞºĞ¾Ğ´.',
    err_enter_password:   'ĞŸĞ¾Ğ¶Ğ°Ğ»ÑƒĞ¹ÑÑ‚Ğ°, Ğ²Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ.',
    err_token_required:   'Ğ¢Ğ¾ĞºĞµĞ½ Ğ¾Ğ±ÑĞ·Ğ°Ñ‚ĞµĞ»ĞµĞ½',
    err_invalid_token:    'ĞĞµĞ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ÑŒĞ½Ñ‹Ğ¹ Ñ‚Ğ¾ĞºĞµĞ½',
    err_saving:           'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ñ…Ñ€Ğ°Ğ½ĞµĞ½Ğ¸Ñ',
    err_unknown:          'ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°',
    err_network:          'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞµÑ‚Ğ¸: ',
    err_auto_create:      'ĞĞ²Ñ‚Ğ¾ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ½Ğµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ. Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ Ñ‚Ğ¾ĞºĞµĞ½ Ğ²Ñ€ÑƒÑ‡Ğ½ÑƒÑ Ğ¸Ğ»Ğ¸ Ğ¿Ñ€Ğ¾Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ.',
    err_bot_start:        'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ±Ğ¾Ñ‚Ğ°',
    err_bot_create:       'ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ±Ğ¾Ñ‚Ğ°',
    err_loading_status:   'ĞÑˆĞ¸Ğ±ĞºĞ° Ğ·Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°',
    err_fill_credentials: 'Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ API credentials Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶ĞµĞ½Ğ¸Ñ',
    ok_token_valid:       'Ğ¢Ğ¾ĞºĞµĞ½ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ‚ĞµĞ»ĞµĞ½! Ğ‘Ğ¾Ñ‚: @{username}',
    ok_bot_created:       'Ğ‘Ğ¾Ñ‚ @{username} ÑĞ¾Ğ·Ğ´Ğ°Ğ½! ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°Ğ¹Ñ‚Ğµ.',
    ok_bot_started:       'Ğ‘Ğ¾Ñ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½!',
    ok_token_saved:       'Ğ¢Ğ¾ĞºĞµĞ½ ÑĞ¾Ñ…Ñ€Ğ°Ğ½Ñ‘Ğ½! ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚Ğµ ÑĞ´Ñ€Ğ¾ Ğ´Ğ»Ñ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ.',
    ok_qr_regenerated:    'QR-ĞºĞ¾Ğ´ Ğ¸ÑÑ‚Ñ‘Ğº, ÑĞ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ½Ğ¾Ğ²Ñ‹Ğ¹',
    ok_enter_credentials: 'Ğ’Ğ²ĞµĞ´Ğ¸Ñ‚Ğµ API credentials Ğ¸ Ğ½Ğ°Ğ¶Ğ¼Ğ¸Ñ‚Ğµ ĞºĞ½Ğ¾Ğ¿ĞºÑƒ QR-ĞºĞ¾Ğ´',
    qr_scan_app:          'ĞÑ‚ÑĞºĞ°Ğ½Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ Ğ² Ğ¿Ñ€Ğ¸Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğ¸ Telegram...',
    qr_new_generated:     'Ğ¡Ğ³ĞµĞ½ĞµÑ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½ Ğ½Ğ¾Ğ²Ñ‹Ğ¹ QR-ĞºĞ¾Ğ´ â€” Ğ¾Ñ‚ÑĞºĞ°Ğ½Ğ¸Ñ€ÑƒĞ¹Ñ‚Ğµ ÑĞ½Ğ¾Ğ²Ğ°!',
    qr_checking:          'ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼...',
    btn_please_wait:      'â³ Ğ–Ğ´Ğ¸Ñ‚Ğµâ€¦',
  }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   i18n engine
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let lang = localStorage.getItem('mcub_lang') || 'en';

function t(key, vars = {}) {
  const str = TRANSLATIONS[lang]?.[key] ?? TRANSLATIONS.en[key] ?? key;
  return str.replace(/\{(\w+)\}/g, (_, k) => vars[k] ?? '');
}

function applyI18n() {
  // textContent â€” covers all simple elements including spans inside labels
  document.querySelectorAll('[data-i18n]').forEach(el => {
    el.textContent = t(el.dataset.i18n);
  });
  // innerHTML â€” for hints that contain links
  document.querySelectorAll('[data-i18n-html]').forEach(el => {
    el.innerHTML = t(el.dataset.i18nHtml);
  });
  document.documentElement.lang = lang;
}

function toggleLang() {
  lang = lang === 'en' ? 'ru' : 'en';
  localStorage.setItem('mcub_lang', lang);
  langToggleBtn.textContent = lang.toUpperCase();
  applyI18n();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Theme
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const toggleBtn     = document.getElementById('themeToggle');
const langToggleBtn = document.getElementById('langToggle');
let dark = localStorage.getItem('mcub_theme') !== 'light';

function applyTheme() {
  document.documentElement.setAttribute('data-theme', dark ? 'dark' : 'light');
  toggleBtn.textContent = dark ? 'ğŸŒ™' : 'â˜€ï¸';
  localStorage.setItem('mcub_theme', dark ? 'dark' : 'light');
}

// Init on load
applyTheme();
applyI18n();
langToggleBtn.textContent = lang.toUpperCase();

toggleBtn.onclick    = () => { dark = !dark; applyTheme(); };
langToggleBtn.onclick = toggleLang;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Toast / UI helpers
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function dismiss(el) {
  el.style.animation = 'slideOut .25s ease forwards';
  setTimeout(() => el.remove(), 250);
}

function shakeInput(id) {
  const el = document.getElementById(id);
  if (!el) return;
  el.classList.remove('shake');
  void el.offsetWidth;
  el.classList.add('shake');
  el.addEventListener('animationend', () => el.classList.remove('shake'), {once:true});
}

function toast(msg, type = 'err') {
  if (type === 'err') {
    const active = document.activeElement;
    if (active && active.tagName === 'INPUT') {
      active.classList.remove('shake');
      void active.offsetWidth;
      active.classList.add('shake');
      active.addEventListener('animationend', () => active.classList.remove('shake'), {once:true});
    }
  }
  const MAX_TOASTS = 5;
  const wrap = document.getElementById('toasts');
  const el   = document.createElement('div');
  el.className = 'toast' + (type === 'ok' ? ' ok' : '');
  el.innerHTML = `<span class="toast-icon">${type === 'ok' ? 'âœ“' : 'âš '}</span><span>${msg}</span><span class="toast-close">âœ•</span>`;
  wrap.prepend(el);
  while (wrap.children.length > MAX_TOASTS) wrap.lastElementChild.remove();
  setTimeout(() => { if (el.isConnected) dismiss(el); }, 6000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Step navigation
   FIX: wstepMap and stepMap were identical objects â€” merged into one
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let _currentStep = 1;

const STEP_MAP = { '1':1, '1qr':2, '2':3, '3':4, '4':5, '5':6 };

function show(n) {
  const idx = STEP_MAP[String(n)];
  if (idx === undefined) return;

  const goingBack = idx < _currentStep;
  _currentStep = idx;

  document.querySelectorAll('.wstep').forEach((el, i) => {
    const visible = i + 1 === idx;
    el.classList.toggle('hidden', !visible);
    if (visible) {
      el.classList.remove('slide-back');
      void el.offsetWidth;
      if (goingBack) el.classList.add('slide-back');
    }
  });

  document.querySelectorAll('.step').forEach((el, i) => {
    el.classList.toggle('active', i + 1 === idx);
    el.classList.toggle('done',   i + 1 < idx);
  });

  document.querySelectorAll('.sconn').forEach((el, i) => {
    el.classList.toggle('filled', i < idx - 1);
  });

  const inp = document.querySelector(`#s${n} input`);
  if (inp) setTimeout(() => inp.focus(), 80);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   btnLoading
   FIX: now saves the original disabled state so it can be correctly restored
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function btnLoading(id, on) {
  const b = document.getElementById(id);
  if (!b) return;
  if (on) {
    b._label    = b.textContent;
    b._disabled = b.disabled;      // save original disabled state
    b.textContent = t('btn_please_wait');
    b.disabled    = true;
  } else {
    b.textContent = b._label ?? b.textContent;
    b.disabled    = b._disabled ?? false;  // restore original state
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HTTP helper
   FIX: handles non-JSON responses (500 HTML error pages) gracefully
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function post(url, body) {
  const r = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  let data = {};
  try { data = await r.json(); } catch (_) { /* non-JSON response */ }
  return { ok: r.ok, status: r.status, ...data };
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QR helper â€” extracted to avoid duplication
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderQR(url) {
  const container = document.getElementById('qr-image');
  container.innerHTML = '';
  new QRCode(container, {
    text: url,
    width: 220, height: 220,
    colorDark: '#000', colorLight: '#fff',
    correctLevel: QRCode.CorrectLevel.M
  });
}

function setQRStatus(key, raw) {
  document.getElementById('qr-status').textContent = raw ?? t(key);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Setup steps
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function step1() {
  const api_id   = document.getElementById('f_api_id').value.trim();
  const api_hash = document.getElementById('f_api_hash').value.trim();
  const phone    = document.getElementById('f_phone').value.trim();
  if (!api_id || !api_hash || !phone) { toast(t('err_fields_required')); return; }
  btnLoading('btn1', true);
  try {
    const r = await post('/api/setup/send_code', { api_id, api_hash, phone });
    if (!r.ok) { toast(r.error || t('err_unknown')); return; }
    show(2);
  } catch(e) { toast(t('err_network') + e.message); }
  finally    { btnLoading('btn1', false); }
}

async function step2() {
  const code = document.getElementById('f_code').value.trim();
  if (!code) { toast(t('err_enter_code')); return; }
  btnLoading('btn2', true);
  try {
    const r = await post('/api/setup/verify_code', { code });
    if (r.requires_2fa) { show(3); return; }
    if (!r.ok) { toast(r.error || t('err_unknown')); return; }
    show(4);
  } catch(e) { toast(t('err_network') + e.message); }
  finally    { btnLoading('btn2', false); }
}

async function step3() {
  const password = document.getElementById('f_pass').value;
  if (!password) { toast(t('err_enter_password')); return; }
  btnLoading('btn3', true);
  try {
    // NOTE: backend accepts { password } at /api/setup/verify_code â€” same endpoint as step2
    const r = await post('/api/setup/verify_code', { password });
    if (!r.ok) { toast(r.error || t('err_unknown')); return; }
    show(4);
  } catch(e) { toast(t('err_network') + e.message); }
  finally    { btnLoading('btn3', false); }
}

async function step1QR() {
  const api_id   = document.getElementById('f_api_id').value.trim();
  const api_hash = document.getElementById('f_api_hash').value.trim();
  if (!api_id || !api_hash) { toast(t('err_api_required')); return; }

  // FIX: manually manage button state â€” never rely on saved _disabled,
  // always force-enable on any error/success so the button can't get stuck
  const btn = document.getElementById('btn1_qr');
  btn._label = btn.textContent;
  btn.textContent = t('btn_please_wait');
  btn.disabled = true;
  const resetBtn = () => { btn.textContent = btn._label; btn.disabled = false; };

  try {
    const r = await post('/api/setup/qr_login', { api_id, api_hash });
    if (!r.ok) { toast(r.error || t('err_unknown')); resetBtn(); return; }
    renderQR(r.qr_url);
    setQRStatus('qr_scan_app');
    show('1qr');
    pollQRLoop();
    resetBtn();
  } catch(e) { toast(t('err_network') + e.message); resetBtn(); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QR polling
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let qrPollInterval = null;

function pollQRLoop() {
  if (qrPollInterval) clearInterval(qrPollInterval);
  qrPollInterval = setInterval(async () => {
    try {
      const r = await post('/api/setup/qr_poll', {});
      if (r.requires_2fa) {
        clearInterval(qrPollInterval);
        show(3);
        return;
      }
      if (r.qr_expired && r.qr_url) {
        renderQR(r.qr_url);
        setQRStatus('qr_new_generated');
        toast(t('ok_qr_regenerated'), 'ok');
        animateQR();
        return;
      }
      if (r.ok && !r.waiting) {
        clearInterval(qrPollInterval);
        show(4);
        return;
      }
      if (r.error) {
        clearInterval(qrPollInterval);
        toast(r.error);
        show(1);
      }
    } catch(_) {}
  }, 3000);
}

// FIX: manual pollQR now also handles qr_expired (was missing before)
async function pollQR() {
  setQRStatus('qr_checking');
  try {
    const r = await post('/api/setup/qr_poll', {});
    if (r.requires_2fa) {
      clearInterval(qrPollInterval);
      show(3);
      return;
    }
    if (r.qr_expired && r.qr_url) {
      renderQR(r.qr_url);
      setQRStatus('qr_new_generated');
      toast(t('ok_qr_regenerated'), 'ok');
      animateQR();
      return;
    }
    if (r.ok && !r.waiting) {
      clearInterval(qrPollInterval);
      show(4);
      return;
    }
    setQRStatus('qr_waiting');
  } catch(e) {
    document.getElementById('qr-status').textContent = t('err_network') + e.message;
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Kernel polling
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function pollKernel() {
  const st = document.getElementById('poll-status');
  let n = 0;
  const interval = setInterval(async () => {
    n++;
    try {
      const r = await fetch('/status');
      if (r.ok) {
        clearInterval(interval);
        st.textContent = t('kernel_ready');
        setTimeout(() => location.href = '/', 1200);
        return;
      }
    } catch(_) {}
    st.textContent = t('kernel_poll', { n });
  }, 2000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Reset modal
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showResetChoice() {
  document.getElementById('resetModal').classList.remove('hidden');
}

async function resetAndChoose(method) {
  document.getElementById('resetModal').classList.add('hidden');
  try { await fetch('/setup/reset', { method: 'GET' }); } catch(_) {}

  if (method === 'qr') {
    show(1);
    toast(t('ok_enter_credentials'), 'ok');
  } else {
    location.reload();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Bot setup (Step 4)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function verifyBotInSetup() {
  const token = document.getElementById('f_bot_token').value.trim();
  if (!token) {
    document.getElementById('btn4').disabled = false;
    return;
  }
  btnLoading('btn4verify', true);
  try {
    const r = await post('/api/bot/verify_token', { token });
    if (!r.ok || !r.valid) { toast(r.error || t('err_invalid_token')); return; }
    toast(t('ok_token_valid', { username: r.username }), 'ok');
    document.getElementById('btn4').disabled = false;
  } catch(e) { toast(t('err_network') + e.message); }
  finally    { btnLoading('btn4verify', false); }
}

async function autoCreateBot() {
  btnLoading('btn4auto', true);
  try {
    const r = await post('/api/bot/auto_create', {});
    if (!r.ok) {
      toast(r.manual ? t('err_auto_create') : (r.error || t('err_bot_create')));
      return;
    }
    document.getElementById('f_bot_token').value = r.token;
    toast(t('ok_bot_created', { username: r.username }), 'ok');
    document.getElementById('btn4').disabled = false;
  } catch(e) { toast(t('err_network') + e.message); }
  finally    { btnLoading('btn4auto', false); }
}

async function skipBot() {
  await post('/api/setup/complete', {});
  show(5);
  pollKernel();
}

async function finishWithBot() {
  const token = document.getElementById('f_bot_token').value.trim();
  btnLoading('btn4', true);
  try {
    if (token) {
      const r = await post('/api/bot/save_token', { token });
      if (!r.ok) { toast(r.error || t('err_saving')); return; }
    }
    await post('/api/setup/complete', {});
    show(5);
    pollKernel();
  } catch(e) { toast(t('err_network') + e.message); }
  finally    { btnLoading('btn4', false); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Bot settings page (/bot)
   FIX: uses correct ID "f_bot_token_page" (was duplicate "f_bot_token")
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadBotStatus() {
  try {
    const r    = await fetch('/api/bot/status');
    const data = await r.json();

    document.getElementById('botStatus').classList.add('hidden');

    if (data.running) {
      document.getElementById('botActions').classList.remove('hidden');
      document.getElementById('botUsernameDisplay').textContent = 'Running as @' + data.username;
      document.getElementById('btnBotStart').textContent = 'Running âœ“';
      document.getElementById('btnBotStart').disabled = true;
    } else if (data.has_token) {
      document.getElementById('botActions').classList.remove('hidden');
      document.getElementById('botUsernameDisplay').textContent = t('ok_token_saved').split('!')[0] + '!';
      document.getElementById('btnBotStart').disabled = false;
    } else {
      document.getElementById('botForm').classList.remove('hidden');
    }
  } catch(_) {
    document.getElementById('botStatus').innerHTML = `<p class="hint">${t('err_loading_status')}</p>`;
  }
}

async function verifyBotToken() {
  const token = document.getElementById('f_bot_token_page').value.trim();
  if (!token) { toast(t('err_token_required')); return; }

  btnLoading('btnBotVerify', true);
  try {
    const r = await post('/api/bot/verify_token', { token });
    if (!r.ok)   { toast(r.error || t('err_invalid_token')); return; }
    if (r.valid) {
      toast(t('ok_token_valid', { username: r.username }), 'ok');
      document.getElementById('btnBotSave').disabled = false;
    }
  } catch(e) { toast(t('err_network') + e.message); }
  finally    { btnLoading('btnBotVerify', false); }
}

async function saveBotToken() {
  const token = document.getElementById('f_bot_token_page').value.trim();
  btnLoading('btnBotSave', true);
  try {
    const r = await post('/api/bot/save_token', { token });
    if (!r.ok) { toast(r.error || t('err_saving')); return; }
    toast(t('ok_token_saved'), 'ok');
    setTimeout(() => location.reload(), 1500);
  } catch(e) { toast(t('err_network') + e.message); }
  finally    { btnLoading('btnBotSave', false); }
}

async function startBot() {
  btnLoading('btnBotStart', true);
  try {
    const r = await post('/api/bot/start', {});
    if (!r.ok) { toast(r.error || t('err_bot_start')); return; }
    toast(t('ok_bot_started'), 'ok');
    setTimeout(() => location.reload(), 1500);
  } catch(e) { toast(t('err_network') + e.message); }
  finally    { btnLoading('btnBotStart', false); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Reauth page
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function showReauthQR() {
  document.getElementById('reauthPage').classList.add('hidden');
  document.getElementById('setupPage').classList.remove('hidden');
  const d = await _prefillFromConfig();
  if (d.ok && d.api_id && d.api_hash) {
    await step1QR();
  } else {
    show(1);
    toast(t('err_fill_credentials'), 'err');
  }
}

async function showReauthCode() {
  document.getElementById('reauthPage').classList.add('hidden');
  document.getElementById('setupPage').classList.remove('hidden');
  const d = await _prefillFromConfig();
  if (d.ok && d.api_id && d.api_hash && d.phone) {
    await step1();
  } else {
    show(1);
    toast(t('err_fill_credentials'), 'err');
  }
}

async function _prefillFromConfig() {
  try {
    const r = await fetch('/api/setup/prefill');
    const d = await r.json();
    if (d.ok) {
      document.getElementById('f_api_id').value   = d.api_id   || '';
      document.getElementById('f_api_hash').value = d.api_hash || '';
      document.getElementById('f_phone').value    = d.phone    || '';
    }
    return d;
  } catch(_) { return {}; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Route: /bot page
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
if (location.pathname === '/bot') {
  document.getElementById('setupPage').classList.add('hidden');
  document.getElementById('botPage').classList.remove('hidden');
  loadBotStatus();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Reauth check (injected by Jinja2 template)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
{% if already_configured %}
document.getElementById('setupPage').classList.add('hidden');
document.getElementById('configuredPage').classList.remove('hidden');
{% elif show_reauth %}
document.getElementById('setupPage').classList.add('hidden');
document.getElementById('reauthPage').classList.remove('hidden');
{% else %}
(async function checkReauth() {
  try {
    const r     = await fetch('/api/setup/state');
    const state = await r.json();
    if (state.needs_reauth) {
      document.getElementById('setupPage').classList.add('hidden');
      document.getElementById('reauthPage').classList.remove('hidden');
    }
  } catch(_) {}
})();
{% endif %}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QR animation helper
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function animateQR() {
  const el = document.getElementById('qr-image');
  el.classList.remove('refreshed');
  void el.offsetWidth;
  el.classList.add('refreshed');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Event listeners (grouped)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.getElementById('f_phone').addEventListener('keydown',    e => e.key === 'Enter' && step1());
document.getElementById('f_code').addEventListener('keydown',     e => e.key === 'Enter' && step2());
document.getElementById('f_pass').addEventListener('keydown',     e => e.key === 'Enter' && step3());
document.getElementById('f_api_hash').addEventListener('keydown', e => e.key === 'Enter' && document.getElementById('f_phone').focus());

// Toast close button
document.getElementById('toasts').addEventListener('click', e => {
  const closeBtn = e.target.closest('.toast-close');
  if (closeBtn) {
    const toastEl = closeBtn.closest('.toast');
    if (toastEl) dismiss(toastEl);
  }
});

// Ripple effect on buttons
document.addEventListener('click', e => {
  const btn = e.target.closest('.btn-primary, .btn-ghost');
  if (!btn) return;
  const r    = document.createElement('span');
  r.className = 'ripple';
  const rect = btn.getBoundingClientRect();
  const size = Math.max(rect.width, rect.height);
  r.style.cssText = `width:${size}px;height:${size}px;left:${e.clientX - rect.left - size / 2}px;top:${e.clientY - rect.top - size / 2}px`;
  btn.appendChild(r);
  r.addEventListener('animationend', () => r.remove());
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   Shooting stars animation
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function rand(a, b) { return Math.random() * (b - a) + a; }

document.querySelectorAll('.wish').forEach(el => {
  function shoot() {
    el.style.top    = rand(10, 80) + 'px';
    el.style.left   = rand(10, 100) + '%';
    el.style.width  = rand(40, 200) + 'px';
    el.style.opacity = 0;
    el.style.animation = 'none';
    el.offsetWidth;
    el.style.animation = `shoot ${rand(1, 3)}s ease-in-out forwards`;
    el.addEventListener('animationend', () => setTimeout(shoot, rand(500, 5000)), { once: true });
  }
  setTimeout(shoot, rand(0, 5000));
});

</script>

<style>
@keyframes shoot{0%{opacity:0;transform:translateX(0);}10%{opacity:1;}80%{opacity:.6;}100%{opacity:0;transform:translateX(-800px);}}
</style>
</body>
</html>
